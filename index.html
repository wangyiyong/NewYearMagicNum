<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 è·¨å¹´æµªæ¼«å€’è®¡æ—¶</title>
    <style>
        /* --- å…¨å±€æ ·å¼ & å­—ä½“ --- */
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@800&family=Noto+Serif+SC:wght@700&display=swap');

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #020010;
            font-family: 'Montserrat', 'Noto Serif SC', sans-serif;
        }

        /* åŒ—æå…‰èƒŒæ™¯ */
        .aurora-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 100%, #1a0b2e, #000000);
            z-index: 0;
            overflow: hidden;
        }

        /* åŒ—æå…‰æ•ˆæœ */
        .aurora {
            position: absolute;
            width: 200%;
            height: 100%;
            top: -50%;
            left: -50%;
            background: linear-gradient(
                45deg,
                transparent 30%,
                rgba(0, 255, 128, 0.1) 40%,
                rgba(0, 200, 255, 0.15) 45%,
                rgba(128, 0, 255, 0.1) 50%,
                rgba(255, 0, 128, 0.1) 55%,
                transparent 60%
            );
            animation: aurora-wave 15s ease-in-out infinite;
            filter: blur(60px);
            opacity: 0.6;
        }

        .aurora:nth-child(2) {
            animation-delay: -7.5s;
            animation-duration: 20s;
            background: linear-gradient(
                -45deg,
                transparent 30%,
                rgba(255, 128, 0, 0.1) 40%,
                rgba(0, 255, 200, 0.15) 45%,
                rgba(100, 0, 255, 0.1) 50%,
                transparent 60%
            );
        }

        @keyframes aurora-wave {
            0%, 100% { transform: translate(-30%, -30%) rotate(0deg); }
            50% { transform: translate(30%, 30%) rotate(180deg); }
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            pointer-events: none;
        }

        /* UI å±‚çº§ */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            pointer-events: auto;
            padding: 40px 20px;
            box-sizing: border-box;
        }

        /* --- é˜¶æ®µä¸€ï¼šç›¸æœºä¸é€‰æ‹© --- */
        .camera-container {
            text-align: center;
            opacity: 0;
            transition: opacity 1s;
            position: relative;
            z-index: 20;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            max-width: 600px;
            width: 100%;
        }

        .polaroid-cam {
            width: 220px;
            height: 200px;
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            border-radius: 25px;
            box-shadow: 0 0 60px rgba(255,215,0, 0.4), 0 10px 40px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            cursor: pointer;
            position: relative;
            animation: float 3s ease-in-out infinite;
            transition: transform 0.3s, box-shadow 0.3s, opacity 0.4s ease;
        }

        .polaroid-cam:hover {
            transform: scale(1.08) translateY(-5px);
            box-shadow: 0 0 80px rgba(255,215,0, 0.6), 0 15px 50px rgba(0,0,0,0.4);
        }

        .polaroid-cam.hiding {
            opacity: 0;
            transform: scale(0.9) translateY(-10px);
            max-height: 200px;
            overflow: hidden;
            margin: 0;
            padding: 0;
            transition: opacity 0.4s ease, transform 0.4s ease, max-height 0.4s ease;
        }

        .lens {
            width: 110px;
            height: 110px;
            background: linear-gradient(145deg, #1a1a1a, #0a0a0a);
            border-radius: 50%;
            border: 6px solid #ddd;
            position: relative;
            overflow: hidden;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.8), 0 5px 15px rgba(0,0,0,0.3);
        }

        .lens::after {
            content: '';
            position: absolute;
            top: 25px;
            right: 25px;
            width: 25px;
            height: 25px;
            background: radial-gradient(circle, rgba(255,255,255,0.6) 0%, rgba(255,255,255,0.2) 100%);
            border-radius: 50%;
        }

        .flash-btn {
            width: 35px;
            height: 35px;
            background: linear-gradient(145deg, #ff6b7a, #ff4757);
            border-radius: 50%;
            position: absolute;
            top: -17px;
            right: 25px;
            border: 4px solid #fff;
            box-shadow: 0 3px 15px rgba(255,71,87,0.6);
        }

        .cam-text {
            color: #fff;
            margin-top: 25px;
            font-size: 1.3rem;
            font-weight: 500;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5), 0 0 20px rgba(255,215,0,0.3);
            letter-spacing: 1px;
            transition: opacity 0.4s ease;
        }

        .cam-text.hiding {
            opacity: 0;
        }

        #file-input {
            display: none;
        }

        /* æµªæ¼«æ ‡é¢˜æ ·å¼ */
        .memory-title {
            color: #fff;
            font-size: 2.8rem;
            font-weight: 700;
            text-align: center;
            margin-bottom: 50px;
            text-shadow: 0 0 20px rgba(255,215,0,0.8), 0 0 40px rgba(255,105,180,0.6);
            letter-spacing: 10px;
            animation: title-glow 3s ease-in-out infinite;
            background: linear-gradient(135deg, #ffd700 0%, #ff69b4 50%, #ffd700 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.3;
            transition: all 0.6s ease;
        }

        @keyframes title-glow {
            0%, 100% {
                filter: brightness(1);
                transform: scale(1);
            }
            50% {
                filter: brightness(1.2);
                transform: scale(1.02);
            }
        }

        /* æ‹ç«‹å¾—ç…§ç‰‡å±•ç¤ºåŠ¨ç”» */
        .polaroid-photos {
            position: relative;
            width: 100%;
            margin-top: 40px;
            pointer-events: none;
            z-index: 5;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
            padding: 20px;
            transition: margin-top 0.5s ease;
            min-height: 0;
        }

        .polaroid-photos.showing {
            margin-top: 0;
        }

        .polaroid-photo {
            width: 130px;
            background: white;
            padding: 10px 10px 30px 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            transform: scale(0) rotate(-20deg);
            opacity: 0;
            /* æ·»åŠ åˆå§‹transitionï¼Œé¿å…é¦–æ¬¡æ˜¾ç¤ºæ—¶è·³å˜ */
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1),
                        opacity 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            will-change: transform, opacity;
        }

        .polaroid-photo.visible {
            opacity: 1;
        }

        .polaroid-photo img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            display: block;
        }

        /* é—ªå…‰ç¯æ•ˆæœ */
        .flash-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 200;
            /* ç§»é™¤é»˜è®¤transitionï¼Œç”±JSåŠ¨æ€æ§åˆ¶ä»¥é¿å…å†²çª */
        }

        /* --- é˜¶æ®µä¸‰ï¼šçº¢åŒ…å¡ç‰‡ --- */
        .card-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 320px;
            background: linear-gradient(135deg, #fff0f0, #fff5f5);
            border-radius: 20px;
            box-shadow: 0 0 50px rgba(255,0,0,0.5);
            z-index: 50;
            padding: 25px;
            text-align: center;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 3px solid #ffd700;
        }

        .card-modal.show {
            transform: translate(-50%, -50%) scale(1);
        }

        .card-img {
            width: 100%;
            height: 240px;
            object-fit: cover;
            border-radius: 15px;
            margin-bottom: 20px;
            border: 5px solid white;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .card-wish {
            font-size: 1.2rem;
            color: #d63031;
            line-height: 1.8;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .close-btn {
            background: linear-gradient(135deg, #ff4757, #ff6b81);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: bold;
            font-size: 1rem;
            box-shadow: 0 5px 15px rgba(255,71,87,0.4);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .close-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255,71,87,0.5);
        }

        /* --- å½©å¸¦æ•ˆæœå®¹å™¨ --- */
        .confetti-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 40;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 20px;
            animation: confetti-fall 3s ease-out forwards;
        }

        @keyframes confetti-fall {
            0% {
                transform: translateY(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(720deg);
                opacity: 0;
            }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        /* æç¤ºæ–‡å­— */
        .instruction {
            position: absolute;
            bottom: 50px;
            color: rgba(255,255,255,0.8);
            font-size: 1rem;
            text-align: center;
            padding: 15px 30px;
            background: rgba(0,0,0,0.3);
            border-radius: 30px;
            backdrop-filter: blur(10px);
            pointer-events: none;
            text-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        /* æ‰‹åŠ¿æç¤º */
        .gesture-hint {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%);
            color: #ffd700;
            font-size: 0.9rem;
            text-align: center;
            opacity: 0.8;
            pointer-events: none;
            z-index: 15;
        }

        .gesture-icon {
            font-size: 2rem;
            margin-bottom: 5px;
            animation: gesture-pulse 1.5s ease-in-out infinite;
        }

        @keyframes gesture-pulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.1); opacity: 1; }
        }

        /* æ‘„åƒå¤´é¢„è§ˆ */
        #camera-preview {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 160px;
            height: 120px;
            border-radius: 10px;
            overflow: hidden;
            border: 3px solid #ffd700;
            box-shadow: 0 0 20px rgba(255,215,0,0.5);
            z-index: 25;
            display: none;
        }

        #camera-preview video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #camera-preview.active {
            display: block;
        }

        /* æ‰‹åŠ¿çŠ¶æ€æŒ‡ç¤º */
        .gesture-status {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 25px;
            background: rgba(0,0,0,0.6);
            border-radius: 25px;
            color: white;
            font-size: 0.9rem;
            z-index: 25;
            display: none;
            backdrop-filter: blur(10px);
            border: 2px solid #ffd700;
        }

        .gesture-status.active {
            display: block;
        }

        .gesture-status.detected {
            background: rgba(0,200,0,0.6);
            border-color: #00ff00;
        }
    </style>
</head>
<body>

    <div class="aurora-bg">
        <div class="aurora"></div>
        <div class="aurora"></div>
    </div>

    <canvas id="mainCanvas"></canvas>
    <canvas id="meteorCanvas"></canvas>

    <div class="flash-overlay" id="flash"></div>
    <div class="confetti-container" id="confettiContainer"></div>

    <div id="ui-layer">

        <div class="camera-container" id="stage1">
            <h1 class="memory-title">âœ¨ 2025Â·å²æœˆå¦‚æ­Œ âœ¨</h1>
            <label for="file-input">
                <div class="polaroid-cam">
                    <div class="flash-btn"></div>
                    <div class="lens"></div>
                </div>
            </label>
            <div class="cam-text">ç‚¹å‡»ç›¸æœºç”Ÿæˆä½ çš„2025å›å¿†</div>
            <div class="cam-text" style="font-size: 0.9rem; opacity: 0.7; margin-top: 10px;">(é€‰æ‹© 5-10 å¼ ç…§ç‰‡)</div>
            <input type="file" id="file-input" multiple accept="image/*">

            <!-- æ‹ç«‹å¾—ç…§ç‰‡å±•ç¤ºå®¹å™¨ -->
            <div class="polaroid-photos" id="polaroidPhotos"></div>
        </div>

        <div class="card-modal" id="cardModal">
            <img src="" alt="Memory" class="card-img" id="modalImg">
            <div class="card-wish" id="modalWish"></div>
            <button class="close-btn" onclick="closeCard()">æ”¶ä¸‹ç¥ç¦ âœ¨</button>
        </div>

        <div class="instruction" id="instruction"></div>

        <div class="gesture-hint" id="gestureHint" style="display: none;">
            <div class="gesture-icon">âœŠ ğŸ‘‰ ğŸ–ï¸</div>
            <div>æ¡æ‹³ç„¶åå¼ å¼€æ‰‹æŒæŠ“å–çº¢åŒ…</div>
        </div>

        <div class="gesture-status" id="gestureStatus">æ£€æµ‹æ‰‹åŠ¿ä¸­...</div>

        <div id="camera-preview">
            <video id="videoElement" autoplay playsinline></video>
        </div>
    </div>

    <!-- MediaPipe Hand Tracking -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

<script>
/**
 * 2026 è·¨å¹´å€’è®¡æ—¶ - å¢å¼ºç‰ˆ
 * åŒ…å«ï¼šåŒ—æå…‰ã€æµæ˜Ÿé›¨ã€ç²’å­å€’è®¡æ—¶ã€çƒŸèŠ±ã€çº¢åŒ…é›¨ã€æ‰‹åŠ¿è¯†åˆ«
 */

// --- é…ç½®ä¸èµ„æº ---
const WISHES = [
    "ğŸ† 2026ï¼Œæ„¿ä½ çš„bugéƒ½å˜æˆfeatureï¼Œå¤´å‘å’Œè´¢å¯Œä¸€æ ·æµ“å¯†ï¼",
    "ğŸŒŸ å‰è·¯æµ©æµ©è¡è¡ï¼Œä¸‡äº‹å°½å¯æœŸå¾…ã€‚2026ï¼Œèµ·é£ï¼",
    "âœ¨ æ‰€æ±‚çš†å¦‚æ„¿ï¼Œæ‰€è¡ŒåŒ–å¦é€”ã€‚æ–°å¹´å¿«ä¹ï¼",
    "ğŸŠ æ‰€æœ‰çš„é—æ†¾éƒ½æ˜¯2026æƒŠå–œçš„é“ºå«ã€‚",
    "ğŸ‡ å‡¡æ˜¯è¿‡å¾€ï¼Œçš†ä¸ºåºç« ã€‚2026ï¼Œè¯·å¤šæŒ‡æ•™ã€‚",
    "ğŸ’« æ„¿ä½ ä¿æŒçƒ­çˆ±ï¼Œå¥”èµ´å±±æµ·ã€‚",
    "ğŸ§§ æ‹’ç»å†…è€—ï¼Œå‘è´¢è¦ç´§ï¼2026å†²é¸­ï¼",
    "ğŸ† çƒŸç«å‘æ˜Ÿè¾°ï¼Œæ‰€æ„¿çš†æˆçœŸã€‚",
    "ğŸŒ™ æ–°çš„ä¸€å¹´ï¼Œæ„¿ä½ çœ¼é‡Œæœ‰å…‰ï¼Œå¿ƒä¸­æœ‰çˆ±ã€‚",
    "ğŸŠ 2026ï¼Œæ„¿æ‰€æœ‰ç¾å¥½å¦‚æœŸè€Œè‡³ï¼",
    "ğŸ’° è´¢æºæ»šæ»šæ¥ï¼Œå¥½è¿è¿è¿è¿ï¼",
    "ğŸ‡ æ„¿ä½ çš„ç”Ÿæ´»å¦‚çƒŸèŠ±èˆ¬ç»šçƒ‚å¤šå½©ï¼"
];

let userPhotos = [];
let gestureEnabled = false;

// --- Canvas è®¾ç½® ---
const canvas = document.getElementById('mainCanvas');
const ctx = canvas.getContext('2d');
const meteorCanvas = document.getElementById('meteorCanvas');
const meteorCtx = meteorCanvas.getContext('2d');

let w, h;

function resize() {
    w = canvas.width = meteorCanvas.width = window.innerWidth;
    h = canvas.height = meteorCanvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

// --- å·¥å…·å‡½æ•° ---
const random = (min, max) => Math.random() * (max - min) + min;
const randomInt = (min, max) => Math.floor(random(min, max));

// --- æ˜Ÿæ˜ŸèƒŒæ™¯ç³»ç»Ÿ ---
class Star {
    constructor() {
        this.reset();
    }

    reset() {
        this.x = random(0, w);
        this.y = random(0, h);
        this.size = random(0.5, 2);
        this.opacity = random(0.3, 1);
        this.twinkleSpeed = random(0.005, 0.02);
        this.twinkleDirection = Math.random() > 0.5 ? 1 : -1;
    }

    update() {
        this.opacity += this.twinkleSpeed * this.twinkleDirection;
        if (this.opacity >= 1 || this.opacity <= 0.3) {
            this.twinkleDirection *= -1;
        }
    }

    draw() {
        ctx.fillStyle = `rgba(255, 255, 255, ${this.opacity})`;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
    }
}

let stars = Array.from({ length: 200 }, () => new Star());

// --- æµæ˜Ÿé›¨ç³»ç»Ÿ ---
class Meteor {
    constructor() {
        this.reset();
    }

    reset() {
        this.x = random(0, w * 1.5);
        this.y = -100;
        this.length = random(80, 200);
        this.speed = random(10, 20);
        this.angle = Math.PI / 4;
        this.opacity = 1;
        this.width = random(1, 3);
    }

    update() {
        this.x -= this.speed * Math.cos(this.angle);
        this.y += this.speed * Math.sin(this.angle);
        this.opacity -= 0.01;

        if (this.y > h + 100 || this.x < -100 || this.opacity <= 0) {
            return false;
        }
        return true;
    }

    draw() {
        meteorCtx.strokeStyle = `rgba(255, 255, 255, ${this.opacity})`;
        meteorCtx.lineWidth = this.width;
        meteorCtx.lineCap = 'round';

        // ç»˜åˆ¶æµæ˜Ÿå°¾è¿¹ï¼ˆæ¸å˜æ•ˆæœï¼‰
        const gradient = meteorCtx.createLinearGradient(
            this.x, this.y,
            this.x + this.length * Math.cos(this.angle),
            this.y - this.length * Math.sin(this.angle)
        );
        gradient.addColorStop(0, `rgba(255, 255, 255, ${this.opacity})`);
        gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');

        meteorCtx.strokeStyle = gradient;
        meteorCtx.beginPath();
        meteorCtx.moveTo(this.x, this.y);
        meteorCtx.lineTo(
            this.x + this.length * Math.cos(this.angle),
            this.y - this.length * Math.sin(this.angle)
        );
        meteorCtx.stroke();

        // æµæ˜Ÿå¤´éƒ¨å…‰æ™•
        meteorCtx.fillStyle = `rgba(255, 255, 255, ${this.opacity})`;
        meteorCtx.shadowColor = 'white';
        meteorCtx.shadowBlur = 10;
        meteorCtx.beginPath();
        meteorCtx.arc(this.x, this.y, 2, 0, Math.PI * 2);
        meteorCtx.fill();
        meteorCtx.shadowBlur = 0;
    }
}

let meteors = [];
let meteorShowerActive = false;

function startMeteorShower() {
    meteorShowerActive = true;
    setTimeout(() => {
        meteorShowerActive = false;
    }, 8000);
}

// --- ç²’å­æ–‡å­—ç³»ç»Ÿï¼ˆå‚è€ƒ tt_index.htmlï¼‰---
// ç²’å­ç±»
class CountdownParticle {
    constructor(x, y) {
        this.x = x + (Math.random() - 0.5) * 200; // åˆå§‹çˆ†ç‚¸ä½ç½®
        this.y = y + (Math.random() - 0.5) * 200;
        this.targetX = x;
        this.targetY = y;
        this.vx = (Math.random() - 0.5) * 2;
        this.vy = (Math.random() - 0.5) * 2;
        this.size = Math.random() * 2 + 1;
        // é‡‘è‰²ç³»éšæœº
        const colors = ['#FFD700', '#FFA500', '#FFEC8B', '#FFF'];
        this.color = colors[Math.floor(Math.random() * colors.length)];
        this.friction = 0.95;
        this.ease = 0.1; // æ±‡èšåŠ›åº¦
    }

    update(isExploding) {
        if (isExploding) {
            // çˆ†ç‚¸æ¨¡å¼ï¼šè¿œç¦»ä¸­å¿ƒæˆ–éšæœºæ•£å¼€
            this.x += this.vx * 10;
            this.y += this.vy * 10;
        } else {
            // æ±‡èšæ¨¡å¼ï¼šå‘ç›®æ ‡ç§»åŠ¨
            let dx = this.targetX - this.x;
            let dy = this.targetY - this.y;
            this.x += dx * this.ease;
            this.y += dy * this.ease;

            // ç®€å•çš„å¾®åŠ¨ï¼ˆå‘¼å¸æ•ˆæœï¼‰
            this.x += (Math.random() - 0.5) * 0.5;
            this.y += (Math.random() - 0.5) * 0.5;
        }
    }

    draw() {
        ctx.fillStyle = this.color;
        ctx.globalCompositeOperation = 'lighter';
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
    }
}

// è·å–æ–‡å­—çš„åƒç´ åæ ‡
function getTextCoordinates(text) {
    const offCanvas = document.createElement('canvas');
    const offCtx = offCanvas.getContext('2d');
    offCanvas.width = w;
    offCanvas.height = h;

    offCtx.font = 'bold 400px Arial';
    offCtx.fillStyle = 'white';
    offCtx.textAlign = 'center';
    offCtx.textBaseline = 'middle';
    offCtx.fillText(text, w / 2, h / 2);

    const imgData = offCtx.getImageData(0, 0, w, h).data;
    const coords = [];
    const gap = 6; // é‡‡æ ·é—´éš”ï¼Œè¶Šå°ç²’å­è¶Šå¤š

    for (let y = 0; y < h; y += gap) {
        for (let x = 0; x < w; x += gap) {
            const index = (y * w + x) * 4;
            if (imgData[index] > 128) { // å¦‚æœæœ‰åƒç´ 
                coords.push({ x, y });
            }
        }
    }
    return coords;
}

let textParticles = [];

function createTextParticles(text) {
    const coords = getTextCoordinates(text);

    // è°ƒæ•´ç²’å­æ•°é‡åŒ¹é…
    if (textParticles.length < coords.length) {
        const diff = coords.length - textParticles.length;
        for (let i = 0; i < diff; i++) {
            textParticles.push(new CountdownParticle(w/2, h/2));
        }
    } else {
        textParticles.splice(coords.length);
    }

    // æ›´æ–°ç›®æ ‡ä½ç½®
    for (let i = 0; i < coords.length; i++) {
        textParticles[i].targetX = coords[i].x;
        textParticles[i].targetY = coords[i].y;
        // é‡ç½®ä¸€ä¸‹ä½ç½®é€ æˆ"æ±‡èš"æ„Ÿ
        textParticles[i].x = Math.random() * w;
        textParticles[i].y = Math.random() * h;
    }
}

// --- å¢å¼ºçƒŸèŠ±ç³»ç»Ÿï¼ˆçœŸå®çˆ†ç‚¸æ•ˆæœç‰ˆï¼‰---
class Firework {
    constructor(type = 'sphere') {
        this.x = random(w * 0.1, w * 0.9);
        this.y = h;
        this.targetY = random(h * 0.15, h * 0.35);
        this.speed = random(10, 14);
        this.angle = -Math.PI / 2 + (Math.random() - 0.5) * 0.3;
        this.vx = Math.cos(this.angle) * this.speed;
        this.vy = Math.sin(this.angle) * this.speed;
        this.hue = random(0, 360);
        this.dead = false;
        this.particles = [];
        this.type = type;
        this.trail = [];

        // é¢„è®¡ç®—é¢œè‰²
        this.color = `hsl(${this.hue}, 100%, 60%)`;
        this.trailColor = `hsla(${this.hue}, 100%, 50%, 0.5)`;
    }

    update() {
        // å°¾è¿¹
        this.trail.push({ x: this.x, y: this.y });
        if (this.trail.length > 5) this.trail.shift();

        this.x += this.vx;
        this.y += this.vy;
        this.vy += 0.08;

        if (this.vy >= 0 || this.y <= this.targetY) {
            this.explode();
            this.dead = true;
        }
    }

    explode() {
        // æ ¹æ®ç±»å‹è®¾ç½®ç²’å­æ•°é‡ï¼š60-100 ä¸ªç²’å­
        let particleCount;
        switch(this.type) {
            case 'heart':
                particleCount = 80;
                break;
            case 'spiral':
                particleCount = 70;
                break;
            default:
                particleCount = 60;
        }

        // ç¬¬ä¸€å±‚ï¼šæ ¸å¿ƒç²’å­ï¼ˆæ˜äº®ã€å¿«é€Ÿï¼‰- 30%
        for (let i = 0; i < Math.floor(particleCount * 0.3); i++) {
            this.particles.push(new FireworkParticle(
                this.x, this.y, this.hue, this.type, 'core'
            ));
        }

        // ç¬¬äºŒå±‚ï¼šä¸­å±‚ç²’å­ï¼ˆä¸»ä½“ï¼‰- 45%
        for (let i = 0; i < Math.floor(particleCount * 0.45); i++) {
            this.particles.push(new FireworkParticle(
                this.x, this.y, this.hue, this.type, 'middle'
            ));
        }

        // ç¬¬ä¸‰å±‚ï¼šå¤–å±‚ç²’å­ï¼ˆè¾ƒæš—ã€è¾ƒæ…¢ã€æŒä¹…ï¼‰- 25%
        for (let i = 0; i < Math.floor(particleCount * 0.25); i++) {
            this.particles.push(new FireworkParticle(
                this.x, this.y, this.hue, this.type, 'outer'
            ));
        }
    }

    draw() {
        // ç»˜åˆ¶å°¾è¿¹
        if (this.trail.length > 1) {
            ctx.beginPath();
            ctx.moveTo(this.trail[0].x, this.trail[0].y);
            for (let i = 1; i < this.trail.length; i++) {
                ctx.lineTo(this.trail[i].x, this.trail[i].y);
            }
            ctx.strokeStyle = this.trailColor;
            ctx.lineWidth = 2;
            ctx.stroke();
        }

        // ç»˜åˆ¶ç«ç®­å¤´
        if (!this.dead) {
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(this.x, this.y, 3, 0, Math.PI * 2);
            ctx.fill();
        }

        // ç»˜åˆ¶ç²’å­
        for (let i = this.particles.length - 1; i >= 0; i--) {
            const p = this.particles[i];
            p.update();
            p.draw();
            if (p.alpha <= 0) {
                this.particles.splice(i, 1);
            }
        }
    }
}

class FireworkParticle {
    constructor(x, y, hue, type = 'sphere', layer = 'middle') {
        this.x = x;
        this.y = y;
        this.hue = hue;
        this.alpha = 1;
        this.type = type;
        this.layer = layer;

        // æ ¹æ®å±‚çº§è®¾ç½®å±æ€§
        let speedMultiplier, sizeMultiplier, decayMultiplier, gravityMultiplier;

        switch(layer) {
            case 'core':
                speedMultiplier = 1.3;
                sizeMultiplier = 1.2;
                decayMultiplier = 1.5;
                gravityMultiplier = 0.8;
                break;
            case 'outer':
                speedMultiplier = 0.7;
                sizeMultiplier = 0.8;
                decayMultiplier = 0.6;
                gravityMultiplier = 1.2;
                break;
            default: // middle
                speedMultiplier = 1.0;
                sizeMultiplier = 1.0;
                decayMultiplier = 1.0;
                gravityMultiplier = 1.0;
        }

        // æ ¹æ®ç±»å‹è®¾ç½®é€Ÿåº¦å’Œè§’åº¦
        let angle, speed;
        switch(type) {
            case 'heart':
                // å¿ƒå½¢å‚æ•°æ–¹ç¨‹
                const t = (Math.PI * 2 * Math.random());
                const heartX = 16 * Math.pow(Math.sin(t), 3);
                const heartY = -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t));
                angle = Math.atan2(heartY, heartX);
                speed = random(4, 8) * Math.sqrt(heartX*heartX + heartY*heartY) / 16 * speedMultiplier;
                break;

            case 'spiral':
                angle = random(0, Math.PI * 2);
                speed = random(5, 12) * speedMultiplier;
                this.spiralAngle = angle;
                this.spiralSpeed = random(0.1, 0.2);
                break;

            default: // sphere
                angle = random(0, Math.PI * 2);
                const gaussian = (Math.random() + Math.random() + Math.random()) / 3;
                speed = (6 + gaussian * 15) * speedMultiplier; // é€Ÿåº¦èŒƒå›´ï¼š6-21
        }

        this.vx = Math.cos(angle) * speed;
        this.vy = Math.sin(angle) * speed;

        // ç‰©ç†å±æ€§
        this.gravity = random(0.05, 0.1) * gravityMultiplier;
        this.friction = random(0.97, 0.985);

        // å¤–è§‚å±æ€§
        this.baseSize = random(1.5, 3) * sizeMultiplier;
        this.size = this.baseSize;

        // è¡°å‡
        this.decay = random(0.008, 0.018) * decayMultiplier;

        // é¢œè‰²å˜åŒ–
        this.hueShift = random(-0.3, 0.3);

        // é—ªçƒï¼ˆæ ¸å¿ƒå±‚æ›´é¢‘ç¹ï¼‰
        this.twinkle = layer === 'core' || random() < 0.25;
        this.twinkleSpeed = random(0.15, 0.35);
        this.twinklePhase = random(0, Math.PI * 2);

        // æ‹–å°¾æ•ˆæœï¼ˆå¤–å±‚ç²’å­æœ‰æ‹–å°¾ï¼‰
        this.hasTrail = layer === 'outer' && random() < 0.5;
        this.trail = [];
        this.maxTrailLength = 3;
    }

    update() {
        // èºæ—‹æ•ˆæœ
        if (this.type === 'spiral') {
            this.spiralAngle += this.spiralSpeed;
            this.vx += Math.cos(this.spiralAngle) * 0.15;
            this.vy += Math.sin(this.spiralAngle) * 0.15;
        }

        // è®°å½•æ‹–å°¾
        if (this.hasTrail && this.alpha > 0.3) {
            this.trail.push({ x: this.x, y: this.y, alpha: this.alpha * 0.5 });
            if (this.trail.length > this.maxTrailLength) {
                this.trail.shift();
            }
        }

        // åº”ç”¨é‡åŠ›å’Œæ‘©æ“¦
        this.vy += this.gravity;
        this.vx *= this.friction;
        this.vy *= this.friction;

        // æ›´æ–°ä½ç½®
        this.x += this.vx;
        this.y += this.vy;

        // é€æ˜åº¦è¡°å‡ï¼ˆåæœŸåŠ é€Ÿï¼‰
        if (this.alpha < 0.4) {
            this.alpha -= this.decay * 2;
        } else {
            this.alpha -= this.decay;
        }

        // å°ºå¯¸å˜åŒ–
        this.size = this.baseSize * Math.max(0.3, this.alpha);

        // é¢œè‰²æ¸å˜
        this.hue += this.hueShift;

        // é—ªçƒ
        if (this.twinkle) {
            this.twinklePhase += this.twinkleSpeed;
        }
    }

    draw() {
        // ç»˜åˆ¶æ‹–å°¾
        if (this.hasTrail && this.trail.length > 0) {
            ctx.globalAlpha = this.alpha * 0.3;
            ctx.fillStyle = `hsl(${this.hue}, 100%, 50%)`;
            for (const t of this.trail) {
                ctx.beginPath();
                ctx.arc(t.x, t.y, this.size * 0.6, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        // è®¡ç®—æœ€ç»ˆé€æ˜åº¦
        let alpha = this.alpha;
        if (this.twinkle) {
            alpha *= 0.75 + Math.sin(this.twinklePhase) * 0.25;
        }

        ctx.globalAlpha = alpha;

        // æ ¹æ®å±‚çº§ä½¿ç”¨ä¸åŒçš„äº®åº¦
        let lightness;
        switch(this.layer) {
            case 'core':
                lightness = 70 + (1 - this.alpha) * 15;
                break;
            case 'outer':
                lightness = 50 + (1 - this.alpha) * 10;
                break;
            default:
                lightness = 60 + (1 - this.alpha) * 15;
        }

        // ç»˜åˆ¶ç²’å­
        ctx.fillStyle = `hsl(${this.hue}, 100%, ${lightness}%)`;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();

        // æ ¸å¿ƒç²’å­é¢å¤–ç»˜åˆ¶é«˜å…‰
        if (this.layer === 'core' && this.alpha > 0.6) {
            ctx.fillStyle = `hsla(${this.hue}, 100%, 90%, ${this.alpha * 0.5})`;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size * 0.5, 0, Math.PI * 2);
            ctx.fill();
        }

        // åœ°é¢åå°„æ•ˆæœï¼ˆçˆ†ç‚¸ç‚¹åœ¨å±å¹•ä¸‹æ–¹ 0.7H ä½ç½®æ—¶ï¼‰
        if (this.y > h * 0.7) {
            const reflectY = h + (h - this.y); // é•œåƒåå°„ä½ç½®
            const reflectAlpha = alpha * 0.3 * (1 - (this.y - h * 0.7) / (h * 0.3)); // è·ç¦»è¶Šè¿œè¶Šæ·¡

            ctx.globalAlpha = reflectAlpha;
            ctx.fillStyle = `hsl(${this.hue}, 100%, ${lightness * 0.8}%)`;
            ctx.beginPath();
            ctx.arc(this.x, reflectY, this.size * 0.8, 0, Math.PI * 2);
            ctx.fill();
        }

        ctx.globalAlpha = 1;
    }
}

let fireworks = [];
const fireworkTypes = ['sphere', 'heart', 'spiral']; // ä¸‰ç§çˆ†ç‚¸æ¨¡å¼

// --- çº¢åŒ…ç³»ç»Ÿï¼ˆç®€æ´ç‰ˆï¼‰---
class RedEnvelope {
    constructor() {
        this.x = random(50, w - 50);
        this.y = -100;
        this.vy = random(2, 5);
        this.dead = false;
    }

    update() {
        this.y += this.vy;
        if (this.y > h + 100) {
            this.dead = true;
        }
    }

    draw() {
        ctx.fillStyle = '#d63031';
        ctx.beginPath();
        ctx.roundRect(this.x - 20, this.y - 30, 40, 60, 5);
        ctx.fill();

        ctx.fillStyle = '#ffd700';
        ctx.font = '16px serif';
        ctx.textAlign = 'center';
        ctx.fillText('ç¦', this.x, this.y + 10);
    }

    isClicked(mx, my) {
        return Math.abs(mx - this.x) < 30 && Math.abs(my - this.y) < 40;
    }
}

let envelopes = [];

// --- å½©å¸¦ç³»ç»Ÿï¼ˆä¼˜åŒ–ç‰ˆï¼‰---
// ä½¿ç”¨å¯¹è±¡æ± å¤ç”¨DOMå…ƒç´ ï¼Œå‡å°‘åˆ›å»ºå’Œé”€æ¯å¼€é”€
const confettiPool = [];
const MAX_CONFETTI = 30; // å‡å°‘å½©å¸¦æ•°é‡

function createConfetti(x, y) {
    const container = document.getElementById('confettiContainer');
    const colors = ['#ff6b6b', '#ffd93d', '#6bcb77', '#4d96ff', '#ff6b9d', '#c44569'];

    // å‡å°‘å½©å¸¦æ•°é‡ï¼Œä»50ä¸ªå‡å°‘åˆ°30ä¸ª
    for (let i = 0; i < MAX_CONFETTI; i++) {
        const confetti = document.createElement('div');
        confetti.className = 'confetti';
        confetti.style.left = x + 'px';
        confetti.style.top = y + 'px';
        confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
        confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
        confetti.style.animationDuration = (2 + Math.random() * 2) + 's';
        confetti.style.animationDelay = (Math.random() * 0.3) + 's';
        container.appendChild(confetti);

        // ä½¿ç”¨requestAnimationFrameç¡®ä¿ä¸‹ä¸€å¸§å†ç§»é™¤ï¼Œé¿å…é˜»å¡
        requestAnimationFrame(() => {
            setTimeout(() => {
                if (confetti.parentNode) {
                    confetti.remove();
                }
            }, 2500); // å‡å°‘åŠ¨ç”»æ—¶é—´
        });
    }
}

// --- æµç¨‹æ§åˆ¶ ---
let currentStage = 0;
let countdownValue = 10;
let isCountdownExploding = false; // å€’è®¡æ—¶ç²’å­çˆ†ç‚¸çŠ¶æ€

function init() {
    requestAnimationFrame(loop);

    const stage1UI = document.getElementById('stage1');
    stage1UI.style.opacity = 1;
}

// ç›‘å¬æ–‡ä»¶ä¸Šä¼  - ä¼˜åŒ–ç‰ˆæœ¬
document.getElementById('file-input').addEventListener('change', function(e) {
    if (this.files && this.files.length > 0) {
        const files = Array.from(this.files);
        const photoCount = Math.min(files.length, 10);

        if (photoCount < 5) {
            alert('è¯·è‡³å°‘é€‰æ‹© 5 å¼ ç…§ç‰‡ï¼');
            return;
        }

        // ç¦ç”¨è¾“å…¥ï¼Œé˜²æ­¢é‡å¤é€‰æ‹©
        this.disabled = true;

        let loadedCount = 0;
        const photosToLoad = files.slice(0, 10);

        // ä½¿ç”¨Promise.allå¤„ç†å¼‚æ­¥åŠ è½½ï¼Œæ›´ä¼˜é›…
        const loadPromises = photosToLoad.map((file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();

                reader.onload = (evt) => resolve(evt.target.result);
                reader.onerror = () => {
                    console.error('å›¾ç‰‡åŠ è½½å¤±è´¥:', file.name);
                    // åŠ è½½å¤±è´¥æ—¶ä½¿ç”¨å ä½å›¾
                    resolve(`https://picsum.photos/320/240?random=${Date.now()}`);
                };

                reader.readAsDataURL(file);
            });
        });

        Promise.all(loadPromises)
            .then((photos) => {
                userPhotos = photos; // ç›´æ¥èµ‹å€¼ï¼Œé¿å…å¤šæ¬¡push
                showPolaroidPhotos();
            })
            .catch((error) => {
                console.error('å›¾ç‰‡åŠ è½½å‡ºé”™:', error);
                alert('éƒ¨åˆ†å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•');
                this.disabled = false;
            });
    }
});

/**
 * æ˜¾ç¤ºæ‹ç«‹å¾—ç…§ç‰‡ - ä¼˜åŒ–ç‰ˆæœ¬
 * ä½¿ç”¨CSSç±»ä»£æ›¿å†…è”æ ·å¼ï¼Œå‡å°‘é‡æ’é‡ç»˜
 * ä½¿ç”¨DocumentFragmentæ‰¹é‡æ’å…¥DOM
 */
function showPolaroidPhotos() {
    // ç¼“å­˜DOMæŸ¥è¯¢
    const flash = document.getElementById('flash');
    const container = document.getElementById('polaroidPhotos');
    const cameraCam = document.querySelector('.polaroid-cam');
    const camTexts = document.querySelectorAll('.cam-text');
    const fileInput = document.getElementById('file-input');

    // 1. é—ªå…‰ç¯æ•ˆæœ
    flash.style.transition = 'opacity 0.3s ease-out';
    flash.style.opacity = 0.6;
    requestAnimationFrame(() => {
        setTimeout(() => {
            flash.style.transition = 'opacity 0.5s ease-in';
            flash.style.opacity = 0;
        }, 200);
    });

    // 2. æ¸…ç©ºå®¹å™¨
    container.innerHTML = '';

    // 3. ä½¿ç”¨DocumentFragmentæ‰¹é‡åˆ›å»ºç…§ç‰‡å…ƒç´ ï¼Œå‡å°‘é‡æ’
    const fragment = document.createDocumentFragment();
    const photoElements = []; // ä¿å­˜å¼•ç”¨ä»¥ä¾¿åç»­åŠ¨ç”»

    userPhotos.forEach((photo, index) => {
        const rotation = random(-15, 15);
        const polaroid = document.createElement('div');
        polaroid.className = 'polaroid-photo';
        polaroid.dataset.rotation = rotation; // ç”¨datasetå­˜å‚¨è§’åº¦

        const img = document.createElement('img');
        img.src = photo;
        img.alt = `Memory ${index + 1}`;
        // æ·»åŠ loadingå±æ€§ä¼˜åŒ–å›¾ç‰‡åŠ è½½
        img.loading = 'eager';

        polaroid.appendChild(img);
        fragment.appendChild(polaroid);
        photoElements.push(polaroid);
    });

    container.appendChild(fragment);

    // 4. ä½¿ç”¨CSSç±»æ§åˆ¶ç›¸æœºéšè—ï¼Œè€Œä¸æ˜¯å†…è”æ ·å¼
    if (cameraCam) {
        cameraCam.classList.add('hiding');
    }
    camTexts.forEach(text => text.classList.add('hiding'));

    // 5. éšè—æ–‡ä»¶è¾“å…¥æ¡†
    fileInput.style.opacity = 0;
    setTimeout(() => {
        fileInput.style.display = 'none';
    }, 300);

    // 6. ç…§ç‰‡å®¹å™¨ä¸Šç§»
    setTimeout(() => {
        container.classList.add('showing');
    }, 100);

    // 7. æ˜¾ç¤ºç…§ç‰‡åŠ¨ç”» - ä½¿ç”¨CSSç±»å’ŒrequestAnimationFrame
    setTimeout(() => {
        photoElements.forEach((photo, index) => {
            setTimeout(() => {
                const rotation = photo.dataset.rotation;
                photo.style.transform = `scale(1) rotate(${rotation}deg)`;
                photo.classList.add('visible');
            }, index * 120);
        });
    }, 200);

    // 8. 4ç§’åæ¸…ç†å¹¶è¿›å…¥ä¸‹ä¸€é˜¶æ®µ
    setTimeout(() => {
        container.innerHTML = '';
        startCountdownStage();
    }, 4000);
}

function startCountdownStage() {
    document.getElementById('stage1').style.display = 'none';
    currentStage = 1;
    startCountdownLogic();
}

function startCountdownLogic() {
    let currentNum = countdownValue;

    // åˆå§‹æ–‡å­—
    createTextParticles(currentNum.toString());

    // å€’è®¡æ—¶å®šæ—¶å™¨
    const interval = setInterval(() => {
        currentNum--;

        if (currentNum < 0) {
            clearInterval(interval);
            startCelebrationStage();
            return;
        }

        // æ•°å­—åˆ‡æ¢åŠ¨ç”»é€»è¾‘ï¼š
        // 1. ç°æœ‰ç²’å­çˆ†ç‚¸
        textParticles.forEach(p => {
            p.vx = (Math.random() - 0.5) * 10;
            p.vy = (Math.random() - 0.5) * 10;
        });
        isCountdownExploding = true;

        // 2. çŸ­æš‚å»¶è¿Ÿåæ±‡èšæˆæ–°æ•°å­—
        setTimeout(() => {
            createTextParticles(currentNum.toString());
            isCountdownExploding = false;
        }, 200);

        // 3-1ç§’è¿›å…¥ç´§å¼ æ¨¡å¼ï¼ˆå˜çº¢ï¼‰
        if (currentNum <= 3) {
            document.getElementById('instruction').innerText = `å³å°†æ¥ä¸´... ${currentNum}`;
            document.getElementById('instruction').style.color = '#ff6b6b';
            document.body.style.boxShadow = `inset 0 0 100px rgba(255,0,0, ${0.2 * (4-currentNum)})`;
        }
    }, 1000); // 1ç§’ä¸€æ¬¡
}

function startCelebrationStage() {
    currentStage = 2;
    createTextParticles("2026");

    document.getElementById('instruction').innerText = 'ğŸ‰ 2026 åˆ°æ¥ï¼æ–°å¹´å¿«ä¹ï¼ ğŸ‰';
    document.getElementById('instruction').style.color = '#ffd700';

    // å¯åŠ¨æµæ˜Ÿé›¨å’Œçº¢åŒ…é›¨
    startMeteorShower();

    setTimeout(() => {
        currentStage = 3;
        textParticles = [];
        document.getElementById('instruction').innerText = 'ğŸ§§ æ»¡å±çº¢åŒ…é›¨æ¥è¢­ï¼ç‚¹å‡»çº¢åŒ…æŠ“å–æƒŠå–œï¼';

        // å°è¯•å¯ç”¨æ‰‹åŠ¿è¯†åˆ«
        tryInitGestureRecognition();

        window.addEventListener('click', handleEnvelopeClick);
        window.addEventListener('touchstart', (e) => {
            handleEnvelopeClick(e.touches[0]);
        });
    }, 5000);
}

// --- æ‰‹åŠ¿è¯†åˆ«ç³»ç»Ÿ ---
let hands = null;
let camera = null;
let videoElement = document.getElementById('videoElement');
let lastGesture = 'open';
let gestureCooldown = false;

async function tryInitGestureRecognition() {
    try {
        // æ£€æŸ¥æ‘„åƒå¤´æ”¯æŒ
        const stream = await navigator.mediaDevices.getUserMedia({
            video: { width: 320, height: 240 }
        });

        gestureEnabled = true;
        document.getElementById('camera-preview').classList.add('active');
        document.getElementById('gestureHint').style.display = 'block';
        document.getElementById('gestureStatus').classList.add('active');

        initMediaPipe();
    } catch (err) {
        console.log('æ‘„åƒå¤´ä¸å¯ç”¨ï¼Œä½¿ç”¨ç‚¹å‡»äº¤äº’');
        gestureEnabled = false;
    }
}

function initMediaPipe() {
    hands = new Hands({
        locateFile: (file) => {
            return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
        }
    });

    hands.setOptions({
        maxNumHands: 1,
        modelComplexity: 1,
        minDetectionConfidence: 0.7,
        minTrackingConfidence: 0.7
    });

    hands.onResults(onHandResults);

    camera = new Camera(videoElement, {
        onFrame: async () => {
            if (hands) {
                await hands.send({ image: videoElement });
            }
        },
        width: 320,
        height: 240
    });

    camera.start();
}

function onHandResults(results) {
    if (!gestureEnabled || currentStage !== 3) return;

    const gestureStatus = document.getElementById('gestureStatus');

    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        const landmarks = results.multiHandLandmarks[0];
        const gesture = detectGesture(landmarks);

        gestureStatus.classList.remove('detected');
        gestureStatus.textContent = `æ‰‹åŠ¿: ${gesture === 'fist' ? 'âœŠ æ¡æ‹³' : 'ğŸ–ï¸ å¼ å¼€'}`;

        if (gesture === 'fist' && lastGesture === 'open' && !gestureCooldown) {
            // æ£€æµ‹åˆ°æ¡æ‹³ï¼Œå‡†å¤‡æŠ“å–
            gestureStatus.textContent = 'âœŠ å‡†å¤‡æŠ“å–... å¼ å¼€æ‰‹æŒï¼';
            lastGesture = 'fist';
        }
        else if (gesture === 'open' && lastGesture === 'fist' && !gestureCooldown) {
            // æ£€æµ‹åˆ°å¼ å¼€æ‰‹æŒï¼Œæ‰§è¡ŒæŠ“å–
            gestureStatus.classList.add('detected');
            gestureStatus.textContent = 'ğŸ–ï¸ æŠ“å–æˆåŠŸï¼';
            grabRandomEnvelope();
            lastGesture = 'open';
            gestureCooldown = true;
            setTimeout(() => { gestureCooldown = false; }, 1500);
        }
        else if (gesture === 'open') {
            lastGesture = 'open';
        }
    } else {
        gestureStatus.textContent = 'æœªæ£€æµ‹åˆ°æ‰‹éƒ¨';
        lastGesture = 'open';
    }
}

function detectGesture(landmarks) {
    // æ£€æµ‹æ‰‹æŒ‡æ˜¯å¦ä¼¸å±•
    const fingerTips = [8, 12, 16, 20]; // é£ŸæŒ‡ã€ä¸­æŒ‡ã€æ— åæŒ‡ã€å°æŒ‡æŒ‡å°–
    const fingerBases = [5, 9, 13, 17]; // å¯¹åº”çš„æŒ‡å…³èŠ‚

    let extendedFingers = 0;

    fingerTips.forEach((tip, i) => {
        if (landmarks[tip].y < landmarks[fingerBases[i]].y) {
            extendedFingers++;
        }
    });

    // æ‹‡æŒ‡æ£€æµ‹
    if (landmarks[4].x < landmarks[3].x) {
        extendedFingers++;
    }

    // æ¡æ‹³ï¼šä¼¸å±•çš„æ‰‹æŒ‡ <= 1
    // å¼ å¼€ï¼šä¼¸å±•çš„æ‰‹æŒ‡ >= 4
    if (extendedFingers <= 1) {
        return 'fist';
    } else if (extendedFingers >= 4) {
        return 'open';
    }
    return 'open';
}

function grabRandomEnvelope() {
    if (envelopes.length === 0) {
        // ç”Ÿæˆä¸€ä¸ªçº¢åŒ…
        const env = new RedEnvelope();
        env.x = w / 2;
        env.y = h / 2;
        envelopes.push(env);
        setTimeout(() => openEnvelope(env.x, env.y), 300);
    } else {
        // éšæœºé€‰æ‹©ä¸€ä¸ªçº¢åŒ…
        const randomIndex = randomInt(0, envelopes.length);
        const env = envelopes[randomIndex];
        openEnvelope(env.x, env.y);
        envelopes.splice(randomIndex, 1);
    }
}

function handleEnvelopeClick(e) {
    if (currentStage !== 3) return;
    const mx = e.clientX;
    const my = e.clientY;

    for (let i = envelopes.length - 1; i >= 0; i--) {
        if (envelopes[i].isClicked(mx, my)) {
            openEnvelope(envelopes[i].x, envelopes[i].y);
            envelopes.splice(i, 1);
            break;
        }
    }
}

function openEnvelope(x, y) {
    // å¤§å¹…å‡å°‘çƒŸèŠ±æ•°é‡ï¼šå›ºå®š2ä¸ªï¼Œé¿å…å¡é¡¿
    const fireworkCount = 2;

    for (let k = 0; k < fireworkCount; k++) {
        // å»¶è¿Ÿå‘å°„ï¼Œä½¿æ•ˆæœæ›´è‡ªç„¶
        setTimeout(() => {
            fireworks.push(new Firework(fireworkTypes[randomInt(0, fireworkTypes.length)]));
        }, k * 150);
    }

    // å½©å¸¦
    createConfetti(x, y);

    // æ˜¾ç¤ºå¡ç‰‡
    const modal = document.getElementById('cardModal');
    const img = document.getElementById('modalImg');
    const wish = document.getElementById('modalWish');

    if (userPhotos.length > 0) {
        img.src = userPhotos[randomInt(0, userPhotos.length)];
    } else {
        img.src = "https://picsum.photos/320/240?random=" + Date.now();
    }

    wish.innerText = WISHES[randomInt(0, WISHES.length)];
    modal.classList.add('show');
}

window.closeCard = function() {
    document.getElementById('cardModal').classList.remove('show');
}

// --- ä¸»å¾ªç¯ï¼ˆä¼˜åŒ–ç‰ˆï¼‰---
function loop() {
    // æ¸…é™¤ä¸»ç”»å¸ƒ - æ ¹æ®é˜¶æ®µä½¿ç”¨ä¸åŒçš„æ¸…é™¤ç­–ç•¥
    if (currentStage === 1 || currentStage === 2) {
        // å€’è®¡æ—¶é˜¶æ®µï¼šå®Œå…¨æ¸…é™¤ç”»å¸ƒï¼Œç¡®ä¿æ–‡å­—æ¸…æ™°æ˜¾ç¤º
        ctx.clearRect(0, 0, w, h);
    } else {
        // çƒŸèŠ±é˜¶æ®µï¼šä½¿ç”¨åŠé€æ˜è¦†ç›–äº§ç”Ÿæ‹–å°¾æ•ˆæœ
        ctx.fillStyle = 'rgba(2, 0, 16, 0.15)';
        ctx.fillRect(0, 0, w, h);
    }

    // æ¸…é™¤æµæ˜Ÿç”»å¸ƒ
    meteorCtx.clearRect(0, 0, w, h);

    // ç»˜åˆ¶æ˜Ÿæ˜Ÿï¼ˆå…¨é˜¶æ®µï¼‰- ä¼˜åŒ–ï¼šåªåœ¨éœ€è¦æ—¶æ›´æ–°
    for (let i = 0; i < stars.length; i++) {
        stars[i].update();
        stars[i].draw();
    }

    // ç²’å­æ–‡å­—ï¼ˆé˜¶æ®µ1å’Œ2ï¼‰
    if (currentStage === 1 || currentStage === 2) {
        for (let i = 0; i < textParticles.length; i++) {
            textParticles[i].update(isCountdownExploding);
            textParticles[i].draw();
        }
    }

    // çƒŸèŠ±ï¼ˆé˜¶æ®µ2å’Œ3ï¼‰
    if (currentStage === 2 || currentStage === 3) {
        // é˜¶æ®µ2ï¼šé™åˆ¶å±å¹•ä¸ŠåŒæ—¶å­˜åœ¨çš„æœ€å¤§çƒŸèŠ±æ•°é‡
        // é˜¶æ®µ3ï¼šåªåœ¨æ‰“å¼€çº¢åŒ…æ—¶äº§ç”ŸçƒŸèŠ±ï¼Œä¸è‡ªåŠ¨ç”Ÿæˆ
        if (currentStage === 2) {
            const maxFireworks = 5;
            const activeFireworks = fireworks.filter(fw => !fw.dead).length;

            if (activeFireworks < maxFireworks) {
                const spawnRate = 0.04;
                if (Math.random() < spawnRate) {
                    fireworks.push(new Firework(fireworkTypes[randomInt(0, fireworkTypes.length)]));
                }
            }
        }
        // é˜¶æ®µ3ä¸è‡ªåŠ¨å‘å°„çƒŸèŠ±ï¼Œåªé€šè¿‡æ‰“å¼€çº¢åŒ…è§¦å‘
    }

    // ç»˜åˆ¶çƒŸèŠ± - å€’åºéå†ä»¥å®‰å…¨åˆ é™¤
    for (let i = fireworks.length - 1; i >= 0; i--) {
        const fw = fireworks[i];
        fw.update();
        fw.draw();
        if (fw.dead && fw.particles.length === 0) {
            fireworks.splice(i, 1);
        }
    }

    // æµæ˜Ÿé›¨ï¼ˆé˜¶æ®µ2å’Œ3ï¼‰- é™ä½ç”Ÿæˆé¢‘ç‡
    if (meteorShowerActive && Math.random() < 0.3) {
        meteors.push(new Meteor());
    }
    // å¶å°”å‡ºç°å•ä¸ªæµæ˜Ÿï¼ˆå…¨é˜¶æ®µï¼‰- é™ä½é¢‘ç‡
    else if (!meteorShowerActive && Math.random() < 0.02) {
        meteors.push(new Meteor());
    }

    // ç»˜åˆ¶æµæ˜Ÿ - ä½¿ç”¨å€’åºéå†
    for (let i = meteors.length - 1; i >= 0; i--) {
        const alive = meteors[i].update();
        if (alive) {
            meteors[i].draw();
        } else {
            meteors.splice(i, 1);
        }
    }

    // çº¢åŒ…é›¨ï¼ˆé˜¶æ®µ3ï¼‰
    if (currentStage === 3) {
        // ç”Ÿæˆçº¢åŒ… - æ§åˆ¶æœ€å¤§æ•°é‡
        if (envelopes.length < 15 && Math.random() < 0.06) {
            envelopes.push(new RedEnvelope());
        }

        // ç»˜åˆ¶çº¢åŒ… - å€’åºéå†
        for (let i = envelopes.length - 1; i >= 0; i--) {
            envelopes[i].update();
            envelopes[i].draw();
            if (envelopes[i].dead) {
                envelopes.splice(i, 1);
            }
        }
    }

    requestAnimationFrame(loop);
}

// å¯åŠ¨
init();

</script>
</body>
</html>
