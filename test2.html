<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 è·¨å¹´æ‰‹åŠ¿äº¤äº’å€’è®¡æ—¶</title>
    <!-- å¼•å…¥ MediaPipe ä¾èµ– -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <style>
        :root { --gold: #ffd700; --red: #ff3e3e; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #000; font-family: "Microsoft YaHei", sans-serif; }
        canvas { position: absolute; top: 0; left: 0; }
        #bg-canvas { z-index: -1; }
        
        /* å¼•å¯¼ä¸çŠ¶æ€ */
        #status-guide {
            position: fixed; top: 20px; width: 100%; text-align: center;
            color: var(--gold); z-index: 1000; font-size: 18px; text-shadow: 0 0 10px #000;
        }

        /* è§†é¢‘æµï¼ˆç”¨äºè¯†åˆ«ï¼Œé€šå¸¸éšè—æˆ–æ”¾åœ¨è§’è½ï¼‰ */
        #input_video {
            position: fixed; bottom: 10px; right: 10px; width: 120px; height: 90px;
            border: 2px solid var(--gold); border-radius: 8px; z-index: 1000;
            transform: scaleX(-1); /* é•œåƒ */
        }

        .stage { display: none; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; position: absolute; }
        .stage.active { display: flex; }

        /* é˜¶æ®µä¸€ï¼šæ‹ç«‹å¾— */
        #camera-box {
            width: 260px; height: 320px; background: #f0f0f0; border-radius: 10px;
            position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .polaroid-photo {
            position: absolute; width: 180px; padding: 10px 10px 30px; background: white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); bottom: 20px; opacity: 0;
        }
        @keyframes photo-out {
            0% { transform: translateY(100%) rotate(0); opacity: 0; }
            100% { transform: translateY(-130%) rotate(-5deg); opacity: 1; }
        }

        /* é˜¶æ®µä¸‰ï¼šçº¢åŒ… */
        .red-envelope {
            width: 100px; height: 140px; background: #e62e2d; border-radius: 10px;
            position: absolute; display: flex; align-items: center; justify-content: center;
            color: var(--gold); font-size: 40px; box-shadow: 0 10px 20px rgba(0,0,0,0.4);
            transition: all 0.5s;
        }
        .hint-circle {
            position: absolute; width: 150px; height: 150px;
            border: 4px dashed var(--gold); border-radius: 50%;
            animation: rotate 5s linear infinite;
        }
        @keyframes rotate { from {transform: rotate(0);} to {transform: rotate(360deg);} }

        /* æœ€ç»ˆå¡ç‰‡ */
        #blessing-card {
            width: 80%; max-width: 320px; background: #fff; border-radius: 20px;
            padding: 20px; text-align: center; display: none; z-index: 2000;
            box-shadow: 0 0 50px var(--gold);
        }
        #blessing-card img { width: 100%; border-radius: 10px; }
        
        .loading-mask {
            position: fixed; inset: 0; background: #000; z-index: 9999;
            display: flex; color: white; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

    <div id="loading" class="loading-mask">æ­£åœ¨åŠ è½½AIæ¨¡å‹ï¼Œè¯·ç¨å€™...</div>
    <div id="status-guide">ç­‰å¾…æˆæƒæ‘„åƒå¤´...</div>
    
    <video id="input_video"></video>
    <canvas id="bg-canvas"></canvas>
    
    <!-- é˜¶æ®µä¸€ -->
    <section id="stage1" class="stage active">
        <div id="camera-box" onclick="document.getElementById('file-input').click()">
            <div style="width:80px; height:80px; border-radius:50%; border:5px solid #ccc;"></div>
            <p style="color:#666">ç‚¹å‡»ä¸Šä¼ å›å¿†ç…§ç‰‡ (5å¼ )</p>
            <input type="file" id="file-input" multiple accept="image/*" style="display:none">
        </div>
    </section>

    <!-- é˜¶æ®µäºŒ -->
    <section id="stage2" class="stage">
        <canvas id="particle-canvas"></canvas>
    </section>

    <!-- é˜¶æ®µä¸‰ -->
    <section id="stage3" class="stage">
        <div class="hint-circle"></div>
        <div id="target-envelope" class="red-envelope">ğŸ§§</div>
        
        <div id="blessing-card">
            <img id="res-img" src="">
            <h2 id="res-text" style="color:var(--red)"></h2>
            <p>2026 é¡ºé¡ºåˆ©åˆ©ï¼</p>
            <button onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
        </div>
    </section>

    <script>
        const statusGuide = document.getElementById('status-guide');
        const videoElement = document.getElementById('input_video');
        let photos = [];
        let gestureState = 'IDLE'; // IDLE -> FIST -> OPEN
        let stage = 1;

        /** 1. MediaPipe æ‰‹åŠ¿è¯†åˆ«é€»è¾‘ **/
        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({
            maxNumHands: 1,
            modelComplexity: 1,
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.7
        });

        hands.onResults(onResults);

        function onResults(results) {
            if (!results.multiHandLandmarks || results.multiHandLandmarks.length === 0) {
                if(stage === 3) statusGuide.innerText = "è¯·å°†æ‰‹æ”¾å…¥ç”»é¢ä¸­";
                return;
            }

            const landmarks = results.multiHandLandmarks[0];
            
            // åˆ¤å®šæ¡æ‹³é€»è¾‘: æŒ‡å°–(8,12,16,20)åˆ°æ‰‹æŒä¸­å¿ƒ(0)çš„è·ç¦»
            const isFist = checkFist(landmarks);

            if (stage === 3) {
                if (gestureState === 'IDLE' && isFist) {
                    gestureState = 'FIST';
                    statusGuide.innerText = "å·²æ¡ç´§ï¼ç°åœ¨å¿«é€Ÿå¼ å¼€æ‰‹æŒï¼";
                    document.getElementById('target-envelope').style.transform = "scale(0.8)";
                } else if (gestureState === 'FIST' && !isFist) {
                    gestureState = 'OPEN';
                    statusGuide.innerText = "è·¨å¹´å¿«ä¹ï¼";
                    triggerOpenEnvelope();
                }
            }
        }

        function checkFist(lm) {
            // ç®€å•é€»è¾‘ï¼šæ¯”è¾ƒæ‰‹æŒ‡ç«¯ç‚¹å’ŒæŒ‡æ ¹çš„Yåæ ‡ï¼ˆåœ¨æ‘„åƒå¤´ç”»é¢ä¸­ï¼ŒæŒ‡å°–ä½äºæŒ‡æ ¹é€šå¸¸æ„å‘³ç€æ¡æ‹³ï¼‰
            const tipIds = [8, 12, 16, 20];
            let foldedCount = 0;
            tipIds.forEach(id => {
                if (lm[id].y > lm[id-2].y) foldedCount++;
            });
            return foldedCount >= 3;
        }

        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 640,
            height: 480
        });
        camera.start().then(() => {
            document.getElementById('loading').style.display = 'none';
            statusGuide.innerText = "æ‘„åƒå¤´å·²å°±ç»ªï¼Œè¯·é€‰æ‹©ç…§ç‰‡";
        });

        /** 2. é˜¶æ®µä¸€ï¼šç…§ç‰‡å¤„ç† **/
        document.getElementById('file-input').addEventListener('change', (e) => {
            const files = Array.from(e.target.files).slice(0, 5);
            files.forEach((file, i) => {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    photos.push(ev.target.result);
                    const p = document.createElement('div');
                    p.className = 'polaroid-photo';
                    p.innerHTML = `<img src="${ev.target.result}" style="width:100%; height:120px; object-fit:cover">`;
                    p.style.left = '40px';
                    p.style.animation = `photo-out 0.8s forwards ${i * 0.4}s`;
                    document.getElementById('stage1').appendChild(p);
                    if(photos.length === files.length) setTimeout(goToStage2, 3000);
                };
                reader.readAsDataURL(file);
            });
        });

        /** 3. é˜¶æ®µäºŒï¼šç²’å­å€’è®¡æ—¶ **/
        function goToStage2() {
            stage = 2;
            document.getElementById('stage1').classList.remove('active');
            document.getElementById('stage2').classList.add('active');
            statusGuide.innerText = "2026 å€’è®¡æ—¶å‡†å¤‡...";
            startCountdown(5); // ä¸ºæ¼”ç¤ºè®¾ä¸º5ç§’
        }

        const pCanvas = document.getElementById('particle-canvas');
        const pCtx = pCanvas.getContext('2d');
        pCanvas.width = window.innerWidth;
        pCanvas.height = window.innerHeight;

        function startCountdown(n) {
            if (n < 0) {
                show2026();
                return;
            }
            drawParticleText(n === 0 ? "HAPPY" : n.toString());
            setTimeout(() => startCountdown(n - 1), 1000);
        }

        function drawParticleText(text) {
            pCtx.clearRect(0, 0, pCanvas.width, pCanvas.height);
            pCtx.fillStyle = "white";
            pCtx.font = "bold 200px Arial";
            pCtx.textAlign = "center";
            pCtx.fillText(text, pCanvas.width/2, pCanvas.height/2 + 70);
            // æ­¤å¤„çœç•¥å¤æ‚çš„ç²’å­ç¼“åŠ¨ä»£ç ï¼ˆå‚è€ƒä¸Šä¸€ç‰ˆï¼‰ï¼Œç›´æ¥è§¦å‘è§†è§‰è½¬æ¢
        }

        function show2026() {
            drawParticleText("2026");
            statusGuide.innerText = "æ–°å¹´å¿«ä¹ï¼å³å°†è¿›å…¥äº’åŠ¨ç¯èŠ‚...";
            setTimeout(goToStage3, 3000);
        }

        /** 4. é˜¶æ®µä¸‰ï¼šæ‰‹åŠ¿æŠ“å– **/
        function goToStage3() {
            stage = 3;
            document.getElementById('stage2').classList.remove('active');
            document.getElementById('stage3').classList.add('active');
            statusGuide.innerText = "ä¼¸æ‰‹å‘é•œå¤´ï¼šå…ˆã€æ¡æ‹³ã€‘æŠ“å–çº¢åŒ…ï¼Œå†ã€å¼ å¼€ã€‘æ‰‹æŒ";
        }

        function triggerOpenEnvelope() {
            const env = document.getElementById('target-envelope');
            env.style.transform = "scale(5) rotate(360deg)";
            env.style.opacity = "0";
            
            setTimeout(() => {
                const card = document.getElementById('blessing-card');
                document.getElementById('res-img').src = photos[Math.floor(Math.random()*photos.length)];
                document.getElementById('res-text').innerText = "2026 æš´å¯Œã€é¡ºé‚ï¼";
                card.style.display = "block";
            }, 600);
        }

        // èƒŒæ™¯ç®€å•æ˜Ÿç©º
        const bgCanvas = document.getElementById('bg-canvas');
        const bgCtx = bgCanvas.getContext('2d');
        bgCanvas.width = window.innerWidth;
        bgCanvas.height = window.innerHeight;
        function animateBg() {
            bgCtx.fillStyle = 'rgba(0,0,0,0.1)';
            bgCtx.fillRect(0,0,bgCanvas.width, bgCanvas.height);
            for(let i=0; i<3; i++) {
                bgCtx.fillStyle = `hsl(${Math.random()*360}, 100%, 70%)`;
                bgCtx.beginPath();
                bgCtx.arc(Math.random()*bgCanvas.width, Math.random()*bgCanvas.height, Math.random()*2, 0, Math.PI*2);
                bgCtx.fill();
            }
            requestAnimationFrame(animateBg);
        }
        animateBg();
    </script>
</body>
</html>